#!/bin/bash -l
#

# FIXME all of this needs to be replaced by leeroy tasks

# set up logging
LOGGER='logger -t [CLOUDINIT] -p daemon.info'

if [[ "${USER}" -ne 0 ]]; then
  $LOGGER "$0 must be run as root."
  exit 1
fi

# can't do much without jq
which jq >/dev/null || exit 1

if [ -r "/etc/profile.d/aws-apitools-common.sh" ]; then
  . /etc/profile.d/aws-apitools-common.sh
fi

INSTANCE_ID=$(ec2-metadata -i | awk '{print $2}')

# determine AWS region
AZ=$(ec2-metadata -z | awk '{print $2}')
REGION=$(echo "$AZ" | sed 's/[[:alpha:]]$//')

AWS="aws --region $REGION"

INSTANCE_NAME=$($AWS ec2 describe-tags --filters "Name=resource-id,Values=${INSTANCE_ID}" | jq -r '.Tags | map(select(.Key == "Name"))[] | .Value')

# log to DataHub
LOGGER="logger -t ${INSTANCE_NAME} -p daemon.info"

$LOGGER "Running SQL fixture..."

# Check that psql command line client is available, fail if not
PSQL=$(which psql)

if [ ! -x "$PSQL" ]; then
  $LOGGER 'Unable to find psql executable, exiting!'
  exit 1
fi

DB_USER=<%= checkEnv('LEEROY_DB_USER') %>
DB_NAME=<%= checkEnv('LEEROY_DB_NAME') %>
DB_HOST=<%= getRDSInstanceEndpoint(checkEnv('LEEROY_DB_HOST')) %>
DB_PASSWORD=<%= checkEnv('LEEROY_DB_PASSWORD') %>
DB_APP_USER=<%= checkEnv('LEEROY_DB_APP_USER') %>

DB_FILE=fixture.sql
DB_TARBALL=fixtures.tar.gz
DB_LOG="${DB_NAME}.log"

# read SQL file from S3
$AWS s3 cp "s3://rk-devops-${REGION}/jenkins/fixtures/sql/${DB_NAME}.sql" $DB_FILE

# run SQL file against database
PGPASSWORD="$DB_PASSWORD" $PSQL -h $DB_HOST -U $DB_USER -f $DB_FILE -d postgres > $DB_LOG

# Check that psql command line client is available, fail if not
FLYWAY=$(which flyway)

if [ ! -x "FLYWAY" ]; then
  $LOGGER 'Unable to find flyway executable, exiting!'
exit 1
fi

# retrieve flyway database scripts from S3
$AWS s3 cp "s3://rk-devops-${REGION}/jenkins/fixtures/sql/flyway-<%= checkEnv('LEEROY_BRANCH') %>.tar.gz" $DB_TARBALL

if [ ! -r "$DB_TARBALL" ]; then
  $LOGGER 'Unable to download FlywayDB fixture, exiting!'
  exit 1
fi

tar zxf $DB_TARBALL
pushd fixtures/core/database

echo "" >> "../../../${DB_LOG}"
echo "$(date -R) beginning FlywayDB run" >> "../../../${DB_LOG}"

for db_name in "$(ls)"; do
  echo "$(date -R) checking ${db_name}" >> "../../../${DB_LOG}"

  if [ -d "${db_name}" ]; then
    flyway_conf="flyway-${db_name}-dev.conf"

    if [ -r "${db_name}/${flyway_conf}" ]; then
      echo "$(date -R) FlywayDB conf found, proceeding" >> "../../../${DB_LOG}"
      cd $db_name

      # create flyway conf file
      echo "$(date -R) writing ${flyway_conf}" >> "../../../${DB_LOG}"
      cat > $flyway_conf <<"FLYWAY_CONF"
flyway.url=jdbc:postgresql://${DB_HOST}/${db_name}
flyway.user=$DB_USER
flyway.password=$DB_PASSWORD
flyway.locations=filesystem:.
flyway.placeholders.appUser=$DB_APP_USER
flyway.placeholders.etlUser=$DB_APP_USER
FLYWAY_CONF

      for flyway_cmd in "clean" "migrate"; do
        echo "$(date -R) running flyway ${flyway_cmd}" >> "../../../${DB_LOG}"
        $FLYWAY -configFile=${flyway_conf} $flyway_cmd >> "../../../${DB_LOG}"
      done

      echo "$(date -R) finished processing ${db_name}" >> "../../../${DB_LOG}"

    fi
  fi
done

popd

# copy log to S3
$AWS s3 cp $DB_LOG "s3://rk-devops-${REGION}/jenkins/logs/${DB_LOG}"

$LOGGER "Removing semaphore..."
$AWS s3 rm "s3://rk-devops-${REGION}/jenkins/semaphores/${INSTANCE_ID}" 2>/dev/null || true

cd ..

$LOGGER "SQL fixture complete."
